<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Hướng dẫn Deploy Tính Năng Đếm Lượt View với Cloudflare D1 · SE-knowledges
    </title>
    <link rel="icon" type="image/svg+xml" href="/SE-knowledges/pr-preview/pr-12/assets/favicon.svg">
    <link rel="stylesheet" href="/SE-knowledges/pr-preview/pr-12/assets/css/style.css" />
  </head>
  <body>
    <header class="site">
  <div class="wrap nav">
    <div class="brand">
      <a class="title" href="/SE-knowledges/pr-preview/pr-12/">SE-knowledges</a>
      <span class="subtitle">Technical notes and articles in Vietnamese and English.</span>
    </div>
    <div>
      
      
      
      

      

      
        <a class="button" href="/SE-knowledges/pr-preview/pr-12/en/">English</a>
        <a class="button" href="/SE-knowledges/pr-preview/pr-12/vi/">Tiếng Việt</a>
      
      
      <!-- Auth Button (Hidden by default, JS toggles) -->
      <a class="button" id="auth-btn" href="/SE-knowledges/pr-preview/pr-12/login.html" style="margin-left: 10px; border: 1px solid #ddd;">Login</a>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      const authBtn = document.getElementById("auth-btn");
      if (token) {
        authBtn.textContent = "Admin";
        authBtn.href = "/SE-knowledges/pr-preview/pr-12/admin.html";
      }
    });
  </script>
</header>

    <main class="wrap">
      <h1 id="hướng-dẫn-deploy-tính-năng-đếm-lượt-view-với-cloudflare-d1">Hướng dẫn Deploy Tính Năng Đếm Lượt View với Cloudflare D1</h1>

<p>Tính năng này sử dụng <strong>Cloudflare Workers</strong> (miễn phí) để xử lý logic đếm và <strong>Cloudflare D1</strong> (SQL Database) để lưu trữ dữ liệu bền vững.</p>

<p>Có 2 cách deploy: <strong>CLI (Khuyến nghị)</strong> hoặc <strong>Dashboard</strong>. Xem phần tương ứng bên dưới.</p>

<hr />

<h2 id="phương-pháp-1-deploy-bằng-cloudflare-cli-wrangler---khuyến-nghị">Phương pháp 1: Deploy bằng Cloudflare CLI (Wrangler) - Khuyến nghị</h2>

<h3 id="bước-1-cài-đặt-wrangler-cli">Bước 1: Cài đặt Wrangler CLI</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">-g</span> wrangler
<span class="c"># hoặc</span>
npm <span class="nb">install</span> <span class="nt">--save-dev</span> wrangler
</code></pre></div></div>

<h3 id="bước-2-đăng-nhập-cloudflare">Bước 2: Đăng nhập Cloudflare</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>backend
wrangler login
</code></pre></div></div>

<p>Lệnh này sẽ mở trình duyệt để bạn đăng nhập vào Cloudflare.</p>

<h3 id="bước-3-tạo-d1-database">Bước 3: Tạo D1 Database</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Tạo D1 database cho production</span>
npm run d1:create

<span class="c"># Hoặc chạy trực tiếp</span>
wrangler d1 create blog-views-db
</code></pre></div></div>

<p>Sau khi chạy lệnh, bạn sẽ nhận được output như:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✅ Successfully created DB 'blog-views-db' in region APAC
Created your database using D1's new storage backend. The new storage backend is not yet recommended for production workloads, but backs up your data via snapshots to R2.

[[d1_databases]]
binding = "DB"
database_name = "blog-views-db"
database_id = "abc123def456..."
</code></pre></div></div>

<p>Copy <code class="language-plaintext highlighter-rouge">database_id</code> và paste vào file <code class="language-plaintext highlighter-rouge">wrangler.toml</code> tại dòng <code class="language-plaintext highlighter-rouge">database_id = "YOUR_D1_DATABASE_ID"</code>.</p>

<h3 id="bước-4-tạo-schema-database">Bước 4: Tạo Schema Database</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Chạy migration để tạo các bảng</span>
npm run d1:migrate
</code></pre></div></div>

<p>Hoặc chạy thủ công:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wrangler d1 execute blog-views-db <span class="nt">--file</span><span class="o">=</span>./schema.sql
</code></pre></div></div>

<h3 id="bước-5-cấu-hình-wranglertoml">Bước 5: Cấu hình wrangler.toml</h3>

<p>Mở file <code class="language-plaintext highlighter-rouge">backend/wrangler.toml</code> và cập nhật:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code>: Tên worker (sẽ tạo URL: <code class="language-plaintext highlighter-rouge">https://&lt;name&gt;.&lt;your-subdomain&gt;.workers.dev</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">database_id</code> trong <code class="language-plaintext highlighter-rouge">[[d1_databases]]</code>: ID từ bước 3</li>
</ul>

<h3 id="bước-6-deploy-worker">Bước 6: Deploy Worker</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Deploy lên production</span>
npm run deploy

<span class="c"># Hoặc chạy trực tiếp</span>
wrangler deploy
</code></pre></div></div>

<p>Sau khi deploy thành công, bạn sẽ nhận được URL của worker (ví dụ: <code class="language-plaintext highlighter-rouge">https://post-views.your-subdomain.workers.dev</code>).</p>

<h3 id="bước-7-test-local-tùy-chọn">Bước 7: Test Local (Tùy chọn)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Chạy worker ở local để test</span>
npm run dev
</code></pre></div></div>

<h3 id="bước-8-cập-nhật-_configyml">Bước 8: Cập nhật _config.yml</h3>

<p>Copy URL worker và paste vào <code class="language-plaintext highlighter-rouge">_config.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">view_api_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://post-views.your-subdomain.workers.dev"</span>
</code></pre></div></div>

<h3 id="các-lệnh-hữu-ích-khác">Các lệnh hữu ích khác</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Xem logs real-time</span>
npm run <span class="nb">tail</span>

<span class="c"># Xem thông tin worker</span>
wrangler <span class="nb">whoami</span>

<span class="c"># Xem danh sách workers</span>
wrangler deployments list

<span class="c"># Query D1 database (ví dụ: SELECT * FROM post_views LIMIT 10)</span>
npm run d1:query <span class="s2">"SELECT * FROM post_views LIMIT 10"</span>

<span class="c"># Xem danh sách D1 databases</span>
wrangler d1 list
</code></pre></div></div>

<hr />

<h2 id="phương-pháp-2-deploy-bằng-cloudflare-dashboard">Phương pháp 2: Deploy bằng Cloudflare Dashboard</h2>

<h3 id="bước-1-tạo-cloudflare-worker">Bước 1: Tạo Cloudflare Worker</h3>

<ol>
  <li>Đăng nhập vào <a href="https://dash.cloudflare.com/">Cloudflare Dashboard</a>.</li>
  <li>Vào mục <strong>Workers &amp; Pages</strong>.</li>
  <li>Nhấn <strong>Create Application</strong> -&gt; <strong>Create Worker</strong>.</li>
  <li>Đặt tên cho worker (ví dụ: <code class="language-plaintext highlighter-rouge">blog-views-d1</code>).</li>
  <li>Nhấn <strong>Deploy</strong> (đừng lo về code mặc định, ta sẽ sửa sau).</li>
</ol>

<h2 id="bước-2-tạo-d1-database">Bước 2: Tạo D1 Database</h2>

<ol>
  <li>Trong dashboard Workers &amp; Pages, chọn <strong>D1</strong> ở menu trái.</li>
  <li>Nhấn <strong>Create Database</strong>.</li>
  <li>Chọn <strong>Dashboard</strong> -&gt; Đặt tên <code class="language-plaintext highlighter-rouge">blog-views-db</code> -&gt; <strong>Create</strong>.</li>
  <li>Vào tab <strong>Console</strong> của database vừa tạo, copy nội dung file <code class="language-plaintext highlighter-rouge">backend/schema.sql</code> và dán vào, sau đó nhấn <strong>Execute</strong> để tạo bảng.</li>
</ol>

<h2 id="bước-3-liên-kết-d1-với-worker">Bước 3: Liên kết D1 với Worker</h2>

<ol>
  <li>Quay lại Worker <code class="language-plaintext highlighter-rouge">blog-views-d1</code> đã tạo ở Bước 1.</li>
  <li>Vào <strong>Settings</strong> -&gt; <strong>Variables</strong>.</li>
  <li>Tại mục <strong>D1 Database Bindings</strong>, nhấn <strong>Add binding</strong>:
    <ul>
      <li><strong>Variable name</strong>: <code class="language-plaintext highlighter-rouge">DB</code> (Bắt buộc phải là tên này).</li>
      <li><strong>D1 Database</strong>: Chọn <code class="language-plaintext highlighter-rouge">blog-views-db</code> vừa tạo.</li>
    </ul>
  </li>
  <li>Nhấn <strong>Save and Deploy</strong>.</li>
</ol>

<h2 id="bước-4-cập-nhật-code-worker">Bước 4: Cập nhật Code Worker</h2>

<ol>
  <li>Vào tab <strong>Overview</strong> của Worker, nhấn <strong>Quick Edit</strong>.</li>
  <li>Xóa hết code cũ, copy toàn bộ nội dung từ file <code class="language-plaintext highlighter-rouge">backend/worker.js</code> trong project này dán vào.</li>
  <li>Nhấn <strong>Save and Deploy</strong>.</li>
</ol>

<h2 id="bước-5-cấu-hình-blog">Bước 5: Cấu hình Blog</h2>

<ol>
  <li>Copy đường dẫn Worker của bạn (dạng <code class="language-plaintext highlighter-rouge">https://blog-views-d1.username.workers.dev</code>).</li>
  <li>Mở file <code class="language-plaintext highlighter-rouge">_config.yml</code> trong source code blog.</li>
  <li>Tìm dòng <code class="language-plaintext highlighter-rouge">view_api_url</code> và dán đường dẫn vào:</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">view_api_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://blog-views-d1.username.workers.dev"</span>
</code></pre></div></div>

<ol>
  <li>Commit và Push code lên GitHub.</li>
</ol>

<h2 id="kiểm-tra">Kiểm tra</h2>

<p>Vào một bài viết bất kỳ trên blog, nếu thấy số lượt view hiển thị (ban đầu là 0 hoặc 1) là thành công!</p>

    </main>
    <footer class="site">
  <div class="wrap">
    <div class="panel">
      <div>
        <span class="pill">EN/VI</span>
        <span class="pill">GitHub Pages</span>
        <span class="pill">Jekyll</span>
      </div>
      <div style="margin-top: 10px;">
        © 2026 SE-knowledges. Built with Jekyll on GitHub Pages.
      </div>
    </div>
  </div>
</footer>


  </body>
</html>

