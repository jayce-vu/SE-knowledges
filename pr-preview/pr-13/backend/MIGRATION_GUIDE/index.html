<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Migration Guide: View Count từ Slug sang Article ID · SE-knowledges
    </title>
    
    <!-- Default Meta Tags -->
    <meta name="description" content="Technical notes and articles in Vietnamese and English." />
    
    <!-- Open Graph / Facebook / LinkedIn / WhatsApp / Telegram / Discord / Slack -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="/SE-knowledges/pr-preview/pr-13/backend/MIGRATION_GUIDE/" />
    <meta property="og:title" content="Migration Guide: View Count từ Slug sang Article ID" />
    <meta property="og:description" content="Technical notes and articles in Vietnamese and English." />
    <meta property="og:site_name" content="SE-knowledges" />
    <meta property="og:locale" content="en_US" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="/SE-knowledges/pr-preview/pr-13/backend/MIGRATION_GUIDE/" />
    <meta name="twitter:title" content="Migration Guide: View Count từ Slug sang Article ID" />
    <meta name="twitter:description" content="Technical notes and articles in Vietnamese and English." />
    
    <!-- Additional Meta Tags for Better Compatibility -->
    <meta name="theme-color" content="#0b1020" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <link rel="icon" type="image/svg+xml" href="/SE-knowledges/pr-preview/pr-13/assets/favicon.svg">
    <link rel="stylesheet" href="/SE-knowledges/pr-preview/pr-13/assets/css/style.css" />
    
  </head>
  <body>
    <header class="site">
  <div class="wrap nav">
    <div class="brand">
      <a class="title" href="/SE-knowledges/pr-preview/pr-13/">SE-knowledges</a>
      <span class="subtitle">Technical notes and articles in Vietnamese and English.</span>
    </div>
    <div>
      
      
      
      

      

      
        <a class="button" href="/SE-knowledges/pr-preview/pr-13/en/">English</a>
        <a class="button" href="/SE-knowledges/pr-preview/pr-13/vi/">Tiếng Việt</a>
      
      
      <!-- Auth Button (Hidden by default, JS toggles) -->
      <a class="button" id="auth-btn" href="/SE-knowledges/pr-preview/pr-13/login/" style="margin-left: 10px; border: 1px solid #ddd;">Login</a>
      <!-- New Post Button (Only visible when logged in) -->
      <a class="button" id="new-post-btn" href="/SE-knowledges/pr-preview/pr-13/admin/" style="margin-left: 10px; border: 1px solid #7ee787; background: rgba(126, 231, 135, 0.1); display: none;">+ New Post</a>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      const authBtn = document.getElementById("auth-btn");
      const newPostBtn = document.getElementById("new-post-btn");
      
      if (token) {
        // User is logged in
        authBtn.textContent = "Admin";
        authBtn.href = "/SE-knowledges/pr-preview/pr-13/admin/";
        newPostBtn.style.display = "inline-block";
      } else {
        // User is not logged in
        newPostBtn.style.display = "none";
      }
    });
  </script>
</header>

    <main class="wrap">
      <h1 id="migration-guide-view-count-từ-slug-sang-article-id">Migration Guide: View Count từ Slug sang Article ID</h1>

<h2 id="tổng-quan">Tổng Quan</h2>

<p>View count đã được thay đổi từ đếm theo <code class="language-plaintext highlighter-rouge">slug</code> sang đếm theo <code class="language-plaintext highlighter-rouge">article_id</code> để tổng hợp view cho tất cả ngôn ngữ của cùng một bài viết.</p>

<h2 id="tại-sao-thay-đổi">Tại Sao Thay Đổi?</h2>

<p><strong>Vấn đề cũ:</strong></p>
<ul>
  <li>Mỗi translation có slug riêng (ví dụ: <code class="language-plaintext highlighter-rouge">bai-viet-tieng-viet</code> và <code class="language-plaintext highlighter-rouge">article-in-english</code>)</li>
  <li>View count được đếm riêng cho mỗi slug</li>
  <li>Cùng một bài viết nhưng khác ngôn ngữ có view count khác nhau → không hợp lý</li>
</ul>

<p><strong>Giải pháp mới:</strong></p>
<ul>
  <li>View count được đếm theo <code class="language-plaintext highlighter-rouge">article_id</code> (tổng hợp cho tất cả ngôn ngữ)</li>
  <li>Tất cả translations của cùng một article sẽ có cùng view count</li>
  <li>Rate limiting vẫn dùng slug để tránh spam theo từng ngôn ngữ</li>
</ul>

<h2 id="thay-đổi-schema">Thay Đổi Schema</h2>

<h3 id="trước">Trước:</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">post_views</span> <span class="p">(</span>
  <span class="n">slug</span> <span class="nb">TEXT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">count</span> <span class="nb">INTEGER</span> <span class="k">DEFAULT</span> <span class="mi">0</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="sau">Sau:</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">post_views</span> <span class="p">(</span>
  <span class="n">article_id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">count</span> <span class="nb">INTEGER</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
  <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">article_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">articles</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">);</span>
</code></pre></div></div>

<h2 id="cách-migrate">Cách Migrate</h2>

<h3 id="bước-1-backup-database">Bước 1: Backup Database</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Export dữ liệu hiện tại (nếu có)</span>
wrangler d1 execute blog-views-db <span class="nt">--command</span> <span class="s2">"SELECT * FROM post_views"</span> <span class="o">&gt;</span> backup_views.json
</code></pre></div></div>

<h3 id="bước-2-chạy-migration-script">Bước 2: Chạy Migration Script</h3>

<p><strong>Option A: Nếu chưa có dữ liệu (Fresh Install)</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Chỉ cần chạy schema.sql mới</span>
wrangler d1 execute blog-views-db <span class="nt">--file</span><span class="o">=</span>./schema.sql
</code></pre></div></div>

<p><strong>Option B: Nếu đã có dữ liệu (Existing Data)</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Chạy migration script</span>
wrangler d1 execute blog-views-db <span class="nt">--file</span><span class="o">=</span>./migrate_views_to_article_id.sql

<span class="c"># Hoặc chạy từng bước thủ công:</span>
<span class="c"># Bước 1: Tạo bảng mới</span>
wrangler d1 execute blog-views-db <span class="nt">--command</span> <span class="s2">"
CREATE TABLE IF NOT EXISTS post_views_new (
  article_id INTEGER PRIMARY KEY,
  count INTEGER DEFAULT 0,
  FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE
);
"</span>

<span class="c"># Bước 2: Migrate dữ liệu</span>
wrangler d1 execute blog-views-db <span class="nt">--command</span> <span class="s2">"
INSERT INTO post_views_new (article_id, count)
SELECT 
    t.article_id,
    COALESCE(SUM(pv.count), 0) as total_count
FROM article_translations t
LEFT JOIN post_views pv ON t.slug = pv.slug
GROUP BY t.article_id
ON CONFLICT(article_id) DO UPDATE SET count = excluded.count;
"</span>

<span class="c"># Bước 3: Xóa bảng cũ và đổi tên</span>
wrangler d1 execute blog-views-db <span class="nt">--command</span> <span class="s2">"
DROP TABLE IF EXISTS post_views;
ALTER TABLE post_views_new RENAME TO post_views;
"</span>
</code></pre></div></div>

<h3 id="bước-3-verify-migration">Bước 3: Verify Migration</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Kiểm tra kết quả</span>
wrangler d1 execute blog-views-db <span class="nt">--command</span> <span class="s2">"
SELECT 
    a.id as article_id,
    COUNT(DISTINCT t.language) as translation_count,
    pv.count as total_views
FROM articles a
LEFT JOIN article_translations t ON a.id = t.article_id
LEFT JOIN post_views pv ON a.id = pv.article_id
GROUP BY a.id, pv.count
ORDER BY pv.count DESC;
"</span>
</code></pre></div></div>

<h2 id="thay-đổi-code">Thay Đổi Code</h2>

<h3 id="worker-code">Worker Code</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">handleViewCount()</code> đã được cập nhật để:
    <ol>
      <li>Resolve slug → article_id từ <code class="language-plaintext highlighter-rouge">article_translations</code></li>
      <li>Đếm view theo <code class="language-plaintext highlighter-rouge">article_id</code> thay vì <code class="language-plaintext highlighter-rouge">slug</code></li>
      <li>Rate limiting vẫn dùng slug (để tránh spam theo ngôn ngữ)</li>
    </ol>
  </li>
</ul>

<h3 id="api-behavior">API Behavior</h3>
<ul>
  <li>API endpoint không thay đổi: vẫn nhận <code class="language-plaintext highlighter-rouge">slug</code> trong query parameter</li>
  <li>Response format không thay đổi: vẫn trả về <code class="language-plaintext highlighter-rouge">{ count: number }</code></li>
  <li>Logic thay đổi: view count giờ là tổng hợp cho tất cả ngôn ngữ</li>
</ul>

<h2 id="testing">Testing</h2>

<p>Sau khi migrate, test các scenarios sau:</p>

<ol>
  <li><strong>Test cùng một article, khác ngôn ngữ:</strong>
```bash
    <h1 id="tạo-view-cho-slug-tiếng-việt">Tạo view cho slug tiếng Việt</h1>
    <p>POST /increment?key=bai-viet-tieng-viet</p>
  </li>
</ol>

<h1 id="kiểm-tra-view-count-cho-slug-tiếng-anh-cùng-article">Kiểm tra view count cho slug tiếng Anh (cùng article)</h1>
<p>GET /?key=article-in-english</p>
<h1 id="kết-quả-count-phải-giống-nhau">Kết quả: count phải giống nhau</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
2. **Test rate limiting:**
```bash
# View slug vi
POST /increment?key=bai-viet-tieng-viet

# Ngay lập tức view slug en (cùng article)
POST /increment?key=article-in-english
# Kết quả: Cả hai đều được đếm (rate limit theo slug)
</code></pre></div></div>

<ol>
  <li><strong>Test với article không tồn tại:</strong>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /?key<span class="o">=</span>non-existent-slug
<span class="c"># Kết quả: 404 "Article not found"</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="rollback-nếu-cần">Rollback (Nếu Cần)</h2>

<p>Nếu cần rollback về schema cũ:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Tạo lại bảng cũ</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">post_views_old</span> <span class="p">(</span>
  <span class="n">slug</span> <span class="nb">TEXT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">count</span> <span class="nb">INTEGER</span> <span class="k">DEFAULT</span> <span class="mi">0</span>
<span class="p">);</span>

<span class="c1">-- Migrate ngược lại (lấy view count từ article_id đầu tiên)</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">post_views_old</span> <span class="p">(</span><span class="n">slug</span><span class="p">,</span> <span class="k">count</span><span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">t</span><span class="p">.</span><span class="n">slug</span><span class="p">,</span>
    <span class="n">pv</span><span class="p">.</span><span class="k">count</span>
<span class="k">FROM</span> <span class="n">article_translations</span> <span class="n">t</span>
<span class="k">JOIN</span> <span class="n">post_views</span> <span class="n">pv</span> <span class="k">ON</span> <span class="n">t</span><span class="p">.</span><span class="n">article_id</span> <span class="o">=</span> <span class="n">pv</span><span class="p">.</span><span class="n">article_id</span>
<span class="k">WHERE</span> <span class="n">t</span><span class="p">.</span><span class="k">language</span> <span class="o">=</span> <span class="s1">'vi'</span><span class="p">;</span> <span class="c1">-- Hoặc ngôn ngữ mặc định</span>

<span class="c1">-- Xóa bảng mới và đổi tên</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">post_views</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">post_views_old</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">post_views</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="faq">FAQ</h2>

<p><strong>Q: Tại sao rate limiting vẫn dùng slug?</strong>
A: Để người dùng có thể xem cả hai ngôn ngữ trong cùng 5 phút. Nếu dùng article_id, người dùng chỉ có thể xem một lần cho tất cả ngôn ngữ.</p>

<p><strong>Q: Có mất dữ liệu khi migrate không?</strong>
A: Không, migration script sẽ tổng hợp view count từ tất cả slugs của cùng một article.</p>

<p><strong>Q: Nếu một article chỉ có 1 translation thì sao?</strong>
A: Vẫn hoạt động bình thường, view count sẽ được lưu theo article_id.</p>

<p><strong>Q: Có cần update frontend không?</strong>
A: Không, API endpoint và response format không thay đổi. Chỉ logic internal thay đổi.</p>


    </main>
    <footer class="site">
  <div class="wrap">
    <div class="panel">
      <div>
        <span class="pill">EN/VI</span>
        <span class="pill">GitHub Pages</span>
        <span class="pill">Jekyll</span>
      </div>
      <div style="margin-top: 10px;">
        © 2026 SE-knowledges. Built with Jekyll on GitHub Pages.
      </div>
    </div>
  </div>
</footer>


    
    <!-- Global API Configuration -->
    <script>
      window.API_URL = "https://se-knowledges.jayce-it-work.workers.dev";
      window.VIEW_API_URL = "https://se-knowledges.jayce-it-work.workers.dev";
      console.log("API URL configured:", window.API_URL);
    </script>
    
    <!-- Load utils.js for all pages -->
    <script src="/SE-knowledges/pr-preview/pr-13/assets/js/utils.js"></script>
    
    <!-- Page-specific scripts -->
    
    
    
    
    
    
    
    
    <!-- Verify utils loaded -->
    <script>
      console.log("Utils loaded:", typeof parseApiResponse !== 'undefined');
    </script>
  </body>
</html>

